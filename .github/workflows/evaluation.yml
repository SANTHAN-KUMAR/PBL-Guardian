# =============================================================================
# PBL Guardian ‚Äî Reusable Evaluation Workflow
# =============================================================================
# This workflow is called by student repos. It runs all evaluation checks
# and posts a bot comment on the commit with the results.
#
# USAGE: Student repos call this via:
#   uses: YOUR-USERNAME/pbl-guardian/.github/workflows/evaluation.yml@main
# =============================================================================

name: "ü§ñ PBL Guardian Evaluation"

on:
  workflow_call:
    inputs:
      source_dir:
        description: "Path to student source code directory"
        required: false
        type: string
        default: "src"
      config_path:
        description: "Path to PBL config file"
        required: false
        type: string
        default: ".pbl/config.json"
    secrets:
      GITHUB_TOKEN_SEARCH:
        description: "GitHub token for Code Search API (optional, for L3 plagiarism)"
        required: false

jobs:
  evaluate:
    name: "üìã Evaluate Commit"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      # --------------------------------------------------
      # 1. Checkout student's repo (full history for git log analysis)
      # --------------------------------------------------
      - name: "üì• Checkout student repo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for contribution & commit analysis

      # --------------------------------------------------
      # 2. Checkout PBL Guardian scripts
      # --------------------------------------------------
      - name: "üì• Checkout PBL Guardian scripts"
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/pbl-guardian
          path: .pbl-guardian
          sparse-checkout: scripts

      # --------------------------------------------------
      # 3. Set up Python
      # --------------------------------------------------
      - name: "üêç Set up Python 3.11"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------------
      # 4. Install dependencies
      # --------------------------------------------------
      - name: "üì¶ Install evaluation dependencies"
        run: |
          pip install -r .pbl-guardian/scripts/requirements.txt

      # --------------------------------------------------
      # 5. Clone reference repos (for L1 plagiarism check)
      # --------------------------------------------------
      - name: "üìö Prepare reference corpus"
        run: |
          mkdir -p references
          # Read reference repos from config if they exist
          if [ -f "${{ inputs.config_path }}" ]; then
            REFS=$(python3 -c "
          import json
          try:
              with open('${{ inputs.config_path }}') as f:
                  config = json.load(f)
              for repo in config.get('reference_repos', []):
                  print(repo)
          except:
              pass
          ")
            while IFS= read -r repo; do
              if [ -n "$repo" ]; then
                echo "Cloning reference: $repo"
                git clone --depth 1 "https://github.com/${repo}.git" "references/$(basename $repo)" 2>/dev/null || echo "Warning: Could not clone $repo"
              fi
            done <<< "$REFS"
          fi

      # --------------------------------------------------
      # 6. Get commit metadata
      # --------------------------------------------------
      - name: "üìù Get commit metadata"
        id: commit_meta
        run: |
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "timestamp=$(git show -s --format=%aI ${{ github.sha }})" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # 7. Run PBL Guardian evaluation
      # --------------------------------------------------
      - name: "üîç Run evaluation"
        id: evaluate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN_SEARCH || secrets.GITHUB_TOKEN }}
          COMMIT_TIMESTAMP: ${{ steps.commit_meta.outputs.timestamp }}
          COMMIT_AUTHOR: ${{ steps.commit_meta.outputs.author }}
          GITHUB_SHA: ${{ github.sha }}
          REPORT_FILE: evaluation_report.md
        run: |
          python3 .pbl-guardian/scripts/evaluate.py \
            --config "${{ inputs.config_path }}" \
            --sha "${{ github.sha }}" \
            --timestamp "${{ steps.commit_meta.outputs.timestamp }}" \
            --author "${{ steps.commit_meta.outputs.author }}" \
            --source-dir "${{ inputs.source_dir }}" \
            --reference-dir "references" \
            --output "evaluation_results.json" || true

          # Read the report for the comment
          if [ -f evaluation_report.md ]; then
            # Escape for GitHub Actions output
            REPORT=$(cat evaluation_report.md)
            # Use delimiter for multiline output
            echo "report<<EOF" >> $GITHUB_OUTPUT
            echo "$REPORT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # --------------------------------------------------
      # 8. Post bot comment on commit
      # --------------------------------------------------
      - name: "üí¨ Post evaluation comment"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let report = '';
            try {
              report = fs.readFileSync('evaluation_report.md', 'utf8');
            } catch (e) {
              report = '## ü§ñ PBL Guardian\n\n‚ö†Ô∏è Evaluation report could not be generated. Check the Actions log for details.';
            }

            // Post comment on the commit
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: report
            });

            console.log('‚úÖ Evaluation comment posted on commit ' + context.sha.substring(0, 7));

      # --------------------------------------------------
      # 9. Upload evaluation artifacts
      # --------------------------------------------------
      - name: "üì§ Upload evaluation report"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "pbl-evaluation-${{ github.sha }}"
          path: |
            evaluation_report.md
            evaluation_results.json
          retention-days: 90
